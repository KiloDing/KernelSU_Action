name: Build Kernel
on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel by ${{ github.actor }}
    runs-on: ubuntu-22.04

    env:
      # 强制自定义 Clang（关键）
      USE_CUSTOM_CLANG: "true"

      # 兜底，防止任何脚本误走 AOSP Clang
      CLANG_BRANCH: "main"
      CLANG_VERSION: "r487747"

      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"

    steps:
    - uses: actions/checkout@v4

    # =========================
    # Prepare config
    # =========================
    - name: Prepare Configuration
      run: |
        CONFIG_ENV=$(grep -w "CONFIG_ENV" config.env | head -n 1 | cut -d "=" -f 2)

        CONFIG_LIST=(
            KERNEL_SOURCE
            KERNEL_SOURCE_BRANCH
            KERNEL_CONFIG
            KERNEL_IMAGE_NAME
            ARCH
            ADD_LOCALVERSION_TO_FILENAME
            EXTRA_CMDS
            CUSTOM_CMDS
            CUSTOM_CLANG_SOURCE
            CUSTOM_CLANG_BRANCH
            ENABLE_GCC_ARM64
            ENABLE_GCC_ARM32
            ENABLE_KERNELSU
            KERNELSU_TAG
            ADD_KPROBES_CONFIG
            ADD_OVERLAYFS_CONFIG
            DISABLE_CC_WERROR
            APPLY_KSU_PATCH
            USE_CUSTOM_ANYKERNEL3
            CUSTOM_ANYKERNEL3_SOURCE
            CUSTOM_ANYKERNEL3_BRANCH
            ENABLE_CCACHE
            NEED_DTBO
            BUILD_BOOT_IMG
            SOURCE_BOOT_IMAGE
            REMOVE_UNUSED_PACKAGES
        )

        for CONFIG in "${CONFIG_LIST[@]}"; do
          if [[ "$CONFIG" == "EXTRA_CMDS" || "$CONFIG" == "CUSTOM_CMDS" ]]; then
            echo "$CONFIG=$(grep -w "$CONFIG" "$CONFIG_ENV" | head -n 1 | cut -d ":" -f 2)" >> $GITHUB_ENV
          else
            echo "$CONFIG=$(grep -w "$CONFIG" "$CONFIG_ENV" | head -n 1 | cut -d "=" -f 2)" >> $GITHUB_ENV
          fi
        done

        # 关键兜底（防止 config.env 解析失败）
        echo "USE_CUSTOM_CLANG=true" >> $GITHUB_ENV

    # =========================
    # System preparation
    # =========================
    - name: Remove unused packages
      if: env.REMOVE_UNUSED_PACKAGES == 'true'
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: false
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: false

    - name: Set swap
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 10

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git ccache automake flex lzop bison gperf build-essential \
          zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 \
          squashfs-tools pngcrush schedtool bc \
          libc6-dev-i386 lib32ncurses5-dev lib32z-dev \
          xsltproc unzip device-tree-compiler python3

        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    # =========================
    # Custom Clang (ONLY)
    # =========================
    - name: Download Custom Clang
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone --depth=1 ${{ env.CUSTOM_CLANG_SOURCE }} \
          -b ${{ env.CUSTOM_CLANG_BRANCH }} clang

    # =========================
    # Kernel source
    # =========================
    - name: Download kernel source
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone --recursive \
          ${{ env.KERNEL_SOURCE }} \
          -b ${{ env.KERNEL_SOURCE_BRANCH }} \
          android-kernel --depth=1

    # =========================
    # KernelSU
    # =========================
    - name: Setup KernelSU
      if: env.ENABLE_KERNELSU == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh \
          | bash -s ${{ env.KERNELSU_TAG }}

    # =========================
    # Kernel config adjustments
    # =========================
    - name: Adjust kernel config
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        CFG=arch/${{ env.ARCH }}/configs/${{ env.KERNEL_CONFIG }}

        if [ "${{ env.APPLY_KSU_PATCH }}" = "true" ]; then
          echo "CONFIG_KSU=y" >> $CFG
        fi

        if [ "${{ env.ADD_KPROBES_CONFIG }}" = "true" ]; then
          echo "CONFIG_KPROBES=y" >> $CFG
          echo "CONFIG_HAVE_KPROBES=y" >> $CFG
        fi

        if [ "${{ env.ADD_OVERLAYFS_CONFIG }}" = "true" ]; then
          echo "CONFIG_OVERLAY_FS=y" >> $CFG
        fi

        if [ "${{ env.DISABLE_CC_WERROR }}" = "true" ]; then
          echo "CONFIG_CC_WERROR=n" >> $CFG
        fi

    # =========================
    # ccache
    # =========================
    - name: Setup ccache
      if: env.ENABLE_CCACHE == 'true'
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: 2G

    # =========================
    # Build kernel
    # =========================
    - name: Build kernel
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel

        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang/bin:$PATH
        export CC=clang
        export CXX=clang++
        export LLVM=1
        export LLVM_IAS=1

        make O=out ARCH=${{ env.ARCH }} ${{ env.KERNEL_CONFIG }}
        make -j$(nproc) O=out ARCH=${{ env.ARCH }}

    # =========================
    # Check outputs
    # =========================
    - name: Check kernel output
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        test -f android-kernel/out/arch/${{ env.ARCH }}/boot/${{ env.KERNEL_IMAGE_NAME }}

    # =========================
    # AnyKernel3
    # =========================
    - name: Make AnyKernel3
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone https://github.com/osm0sis/AnyKernel3 --depth=1
        cp android-kernel/out/arch/${{ env.ARCH }}/boot/${{ env.KERNEL_IMAGE_NAME }} AnyKernel3/

        if [ "${{ env.NEED_DTBO }}" = "true" ] && \
           [ -f android-kernel/out/arch/${{ env.ARCH }}/boot/dtbo.img ]; then
          cp android-kernel/out/arch/${{ env.ARCH }}/boot/dtbo.img AnyKernel3/
        fi

        rm -rf AnyKernel3/.git* AnyKernel3/README.md

    # =========================
    # Upload
    # =========================
    - name: Upload AnyKernel3
      uses: actions/upload-artifact@v4
      with:
        name: AnyKernel3-${{ env.DEVICE }}-${{ github.run_number }}
        path: kernel_workspace/AnyKernel3/*
